import { apiClient } from "@/shared/infrastructure/http";
import type { StockMovement } from "../../domain/entities/stock-movement.entity";
import type {
  StockMovementRepositoryPort,
  PaginatedResult,
} from "../../application/ports/stock-movement.repository.port";
import type {
  StockMovementListResponseDto,
  StockMovementResponseDto,
  CreateStockMovementDto,
  StockMovementFilters,
} from "../../application/dto/stock-movement.dto";
import { StockMovementMapper } from "../../application/mappers/stock-movement.mapper";

interface ApiResponse<T> {
  data: T;
}

export class StockMovementApiAdapter implements StockMovementRepositoryPort {
  private readonly basePath = "/inventory/movements";

  async findAll(filters?: StockMovementFilters): Promise<PaginatedResult<StockMovement>> {
    const response = await apiClient.get<StockMovementListResponseDto>(this.basePath, {
      params: this.buildQueryParams(filters),
    });

    return {
      data: response.data.data.map(StockMovementMapper.toDomain),
      pagination: response.data.pagination,
    };
  }

  async findById(id: string): Promise<StockMovement | null> {
    try {
      const response = await apiClient.get<ApiResponse<StockMovementResponseDto>>(
        `${this.basePath}/${id}`
      );
      return StockMovementMapper.toDomain(response.data.data);
    } catch (error) {
      if (this.isNotFoundError(error)) {
        return null;
      }
      throw error;
    }
  }

  async create(data: CreateStockMovementDto): Promise<StockMovement> {
    const response = await apiClient.post<ApiResponse<StockMovementResponseDto>>(
      this.basePath,
      data
    );
    return StockMovementMapper.toDomain(response.data.data);
  }

  async post(id: string): Promise<StockMovement> {
    const response = await apiClient.post<ApiResponse<StockMovementResponseDto>>(
      `${this.basePath}/${id}/post`
    );
    return StockMovementMapper.toDomain(response.data.data);
  }

  async void(id: string): Promise<StockMovement> {
    const response = await apiClient.post<ApiResponse<StockMovementResponseDto>>(
      `${this.basePath}/${id}/void`
    );
    return StockMovementMapper.toDomain(response.data.data);
  }

  private buildQueryParams(filters?: StockMovementFilters): Record<string, unknown> {
    if (!filters) return {};

    const params: Record<string, unknown> = {};

    if (filters.warehouseId) {
      params.warehouseId = filters.warehouseId;
    }
    if (filters.type) {
      params.type = filters.type;
    }
    if (filters.status) {
      params.status = filters.status;
    }
    if (filters.productId) {
      params.productId = filters.productId;
    }
    if (filters.startDate) {
      params.startDate = filters.startDate;
    }
    if (filters.endDate) {
      params.endDate = filters.endDate;
    }
    if (filters.search) {
      params.search = filters.search;
    }
    if (filters.page) {
      params.page = filters.page;
    }
    if (filters.limit) {
      params.limit = filters.limit;
    }

    return params;
  }

  private isNotFoundError(error: unknown): boolean {
    return (
      typeof error === "object" &&
      error !== null &&
      "response" in error &&
      typeof (error as { response?: { status?: number } }).response === "object" &&
      (error as { response: { status?: number } }).response?.status === 404
    );
  }
}

export const stockMovementApiAdapter = new StockMovementApiAdapter();
