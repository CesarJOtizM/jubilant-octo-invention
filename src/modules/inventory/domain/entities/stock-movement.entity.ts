import { Entity } from "@/shared/domain";

export type MovementType =
  | "IN"
  | "OUT"
  | "ADJUST_IN"
  | "ADJUST_OUT"
  | "TRANSFER_IN"
  | "TRANSFER_OUT";

export type MovementStatus = "DRAFT" | "POSTED" | "VOID";

export interface MovementLine {
  id: string;
  productId: string;
  productName: string;
  productSku: string;
  quantity: number;
  unitCost: number | null;
}

export interface StockMovementProps {
  id: string;
  warehouseId: string;
  warehouseName: string;
  type: MovementType;
  status: MovementStatus;
  reference: string | null;
  reason: string | null;
  note: string | null;
  lines: MovementLine[];
  createdBy: string;
  createdAt: Date;
  postedAt: Date | null;
}

export class StockMovement extends Entity<string> {
  private readonly props: Omit<StockMovementProps, "id">;

  private constructor(id: string, props: Omit<StockMovementProps, "id">) {
    super(id);
    this.props = props;
  }

  static create(props: StockMovementProps): StockMovement {
    return new StockMovement(props.id, {
      warehouseId: props.warehouseId,
      warehouseName: props.warehouseName,
      type: props.type,
      status: props.status,
      reference: props.reference,
      reason: props.reason,
      note: props.note,
      lines: props.lines,
      createdBy: props.createdBy,
      createdAt: props.createdAt,
      postedAt: props.postedAt,
    });
  }

  get warehouseId(): string {
    return this.props.warehouseId;
  }

  get warehouseName(): string {
    return this.props.warehouseName;
  }

  get type(): MovementType {
    return this.props.type;
  }

  get status(): MovementStatus {
    return this.props.status;
  }

  get reference(): string | null {
    return this.props.reference;
  }

  get reason(): string | null {
    return this.props.reason;
  }

  get note(): string | null {
    return this.props.note;
  }

  get lines(): MovementLine[] {
    return this.props.lines;
  }

  get totalItems(): number {
    return this.props.lines.length;
  }

  get totalQuantity(): number {
    return this.props.lines.reduce((sum, line) => sum + line.quantity, 0);
  }

  get createdBy(): string {
    return this.props.createdBy;
  }

  get createdAt(): Date {
    return this.props.createdAt;
  }

  get postedAt(): Date | null {
    return this.props.postedAt;
  }

  // Type helpers
  get isEntry(): boolean {
    return this.props.type === "IN" || this.props.type === "ADJUST_IN" || this.props.type === "TRANSFER_IN";
  }

  get isExit(): boolean {
    return this.props.type === "OUT" || this.props.type === "ADJUST_OUT" || this.props.type === "TRANSFER_OUT";
  }

  get isAdjustment(): boolean {
    return this.props.type === "ADJUST_IN" || this.props.type === "ADJUST_OUT";
  }

  get isTransfer(): boolean {
    return this.props.type === "TRANSFER_IN" || this.props.type === "TRANSFER_OUT";
  }

  // Status helpers
  get isDraft(): boolean {
    return this.props.status === "DRAFT";
  }

  get isPosted(): boolean {
    return this.props.status === "POSTED";
  }

  get isVoid(): boolean {
    return this.props.status === "VOID";
  }

  get canPost(): boolean {
    return this.props.status === "DRAFT";
  }

  get canVoid(): boolean {
    return this.props.status === "POSTED";
  }
}
